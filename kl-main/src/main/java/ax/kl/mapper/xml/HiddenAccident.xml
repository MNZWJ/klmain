<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ax.kl.mapper.HiddenAccidentMapper">

    <!--加载危险源列表-->
    <select id="getHazardList" resultType="ax.kl.entity.MajorHazard">

        SELECT
        di.SourceId,di.SourceName,di.Longt,di.Lat
        FROM
        TB_BASE_DANGERSOURCE_INFO di
        JOIN TB_BASE_COMPANY_INFO ci ON di.CompanyId=ci.CompanyId
        JOIN  TB_BASE_HIDDEN_DANGER hd ON di.SourceId=hd.DangerSource

        WHERE
        di.SourceId IS NOT NULL

        <if test="searchCompanyName!=null and searchCompanyName!= ''">
            AND ci.CompanyName LIKE CONCAT('%',CONCAT(#{searchCompanyName},'%'))
        </if>
        <if test="searchSourceName!=null and searchSourceName!= ''">
            AND di.SourceName LIKE CONCAT('%',CONCAT(#{searchSourceName},'%'))
        </if>
        <if test="searchRank!=null and searchRank!= ''">
            AND di.Rank = #{searchRank}
        </if>
        <if test="searchRankHidden!=null and searchRankHidden!= ''">
            AND hd.Rank=#{searchRankHidden}
        </if>
        AND  hd.DangerId IS NOT NULL
        AND isnull(hd.Rectification,'')!='已整改'
        GROUP BY di.SourceId,di.SourceName,di.Longt,di.Lat


    </select>

    <!--获取隐患信息-->
    <select id="getHiddenInfo" resultType="ax.kl.entity.HiddenAccident">
        SELECT hd.*,di.SourceName,ci.CompanyName FROM TB_BASE_HIDDEN_DANGER hd
        JOIN TB_BASE_DANGERSOURCE_INFO di ON hd.DangerSource=di.SourceId
        JOIN TB_BASE_COMPANY_INFO ci ON di.CompanyId=ci.CompanyId
        <if test="sourceId!=null and sourceId!=''">
            WHERE di.SourceId=#{sourceId}
        </if>
    </select>


</mapper>